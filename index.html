<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Shaders with Three.js</title>
    <link src="src/styles/styles.css"></link>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <canvas id="canvas"></canvas>

    <script id="vertexShader_buffer" type="x-shader/x-vertex">
        attribute vec4 a_position;  
        uniform mat4 u_modelViewMatrix;
        uniform mat4 u_projectionMatrix;

        void main() {
            gl_Position = a_position;
        }
    </script>

    <script id="fragmentShader_under" type="x-shader/x-vertex">
        #extension GL_OES_standard_derivatives : enable
        precision highp float;

        uniform vec2 u_resolution;
        uniform vec2 u_mouse;
        uniform float u_time;
        uniform sampler2D u_noise;
        uniform vec2 u_point;

        vec2 getScreenSpace(vec2 coords) {
            vec2 uv = (coords - 0.5 * u_resolution.xy) / min(u_resolution.y, u_resolution.x);
            return uv;
        }

        float sdLine( in vec2 p, in vec2 a, in vec2 b ) {
            vec2 pa = p-a, ba = b-a;
            float h = clamp( dot(pa,ba)/dot(ba,ba), 0.0, 1.0 );
            return length( pa - ba*h );
        }

        const vec2 lw = vec2(.002, 1.);
        const float multiplier = 2.;
        const float inter = .999;

        vec3 pattern(vec2 uv) {
            vec3 colour = vec3(0.);
            uv *= multiplier;
            vec2 mouse = getScreenSpace(u_mouse.xy) * multiplier * vec2(1,-1);
            vec2 point = getScreenSpace(u_point.xy) * multiplier * vec2(1,-1);
            float modifier = smoothstep(1., -1., uv.x);
            float repeater = 100. - modifier * 50.;
            float integral = inter - modifier * .5;
            float lwidth = lw.x + modifier * .02;
            float line = sdLine(uv, point, mouse);
            float aa = fwidth(line)*lw.y;
            float aa1 = fwidth(line*50.)*2.;
            float sl = sin(line*repeater - u_time*20.);
            line = smoothstep(lw.x - aa, lw.x + aa, line);
            colour = vec3(smoothstep(integral, integral-aa1, sl) * smoothstep(-integral, -integral+aa1, sl));
            colour = mix(vec3(0.), colour, line);
            float sx = sin((uv.y + mouse.x + sin(uv.x*10.) * .05) * repeater);
            colour = min(colour, vec3(smoothstep(integral, integral-aa1, sx) * smoothstep(-integral, -integral+aa1, sx)));
            return colour;
        }

        void main() {
            vec2 uv = getScreenSpace(gl_FragCoord.xy);
            vec3 colour = pattern(uv);
            gl_FragColor = vec4(colour,1.0);
        }
    </script>

    <script>
        var canvas = document.getElementById("canvas");
        var renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 1;

        var uniforms = {
            u_time: { type: "f", value: 1.0 },
            u_resolution: { type: "v2", value: new THREE.Vector2() },
            u_mouse: { type: "v2", value: new THREE.Vector2() },
            u_point: { type: "v2", value: new THREE.Vector2() }
        };

        var geometry = new THREE.PlaneGeometry(2, 2);
        var material = new THREE.ShaderMaterial({
            uniforms: uniforms,
            vertexShader: document.getElementById('vertexShader_buffer').textContent,
            fragmentShader: document.getElementById('fragmentShader_under').textContent
        });

        var mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        function onWindowResize(event) {
            renderer.setSize(window.innerWidth, window.innerHeight);
            uniforms.u_resolution.value.x = renderer.domElement.width;
            uniforms.u_resolution.value.y = renderer.domElement.height;
        }

        window.addEventListener('resize', onWindowResize, false);
        onWindowResize();

        document.onmousemove = function(e) {
            uniforms.u_mouse.value.x = e.pageX;
            uniforms.u_mouse.value.y = e.pageY;
        };

        function animate() {
            requestAnimationFrame(animate);
            uniforms.u_time.value += 0.05;
            renderer.render(scene, camera);
        }

        animate();
    </script>
    <script src="src/javascript/sketch.js"></script>
</body>
</html>
